% engine=luatex
\pdfcompresslevel0
 
%\newcount\crashcounter
%\appendtoks
%\ifnum\crashcounter=85 \stoptext \fi
%\global\advance\crashcounter\plusone
%[\the\crashcounter]
% \ctxlua{%
%    texio.write_nl("PAR NUMBER: \the\crashcounter")
%    for _,v in pairs(statistics.list()) do texio.write_nl (_ .. "=" .. v) end
%}\to\everypar

\environment luatexref-env

\setupalign[flushleft]

\catcode`\_=12

\def\hex{"}

\def\todo#1{{\bf\red <TODO: #1>}}

\starttext
\TitlePage{Snapshot 2006-10-23}

%\appendtoks \newlinechar13 \to\everyMPgraphic

\title{Contents}

\placecontent[criterium=text,level=subsection]

\chapter{Introduction}


\startframedtext[framecolor=red,width=\hsize]
\red 
This book will eventually become the reference manual of \LUATEX. At
the moment, it simply reports the behavior of the executable
matching the snapshot date in the title page.

\blank

Features may come and go. The current version of \LUATEX\ is not meant
for production and users cannot depend on functionality staying the
same.

\blank

Nothing in the API is considered stable just yet. This manual
therefore simply reflects the current state of the executable. {\bs 
Absolutely nothing\/} on the following pages is set in stone. When the
need arises, anything can (and will) be changed without prior notice.

\blank

\bf If you are unhappy with this situation, wait for the public beta's.
\stopframedtext

\blank[2*line]

\LUATEX\ consists of a number of interrelated but (still) distinguishable
 parts:
\startitemize
\item \PDFTEX\ version 1.40  (currently in beta)
\item \ALEPH\ RC4 (from the \TEXLIVE\ repository)
\item Functionality of \ETEX\ 2.2
\item Lua 5.1.1
\item Dedicated lua libraries
\item Various \TeX\ extensions
\item Compiled source code to glue it all together
\stopitemize

\LUATEX\ has two separate identities:

\startitemize[n]
\item When \type{\pdfoutput} is set to one, \LUATEX\ behaves like \PDFTEX,
with the addition of (8-bit) OTP processing.  In this mode, fonts are
limited to 256 characters, and hyphenation is only available for 8-bit
font encodings. Attempts to use the \ALEPH\ direction commands will
generate erroneous output.

\item When \type{\pdfoutput} is zero, \LUATEX\ behaves like \ALEPH\ with the
addition of the micro-typography features. In this mode, fonts can have
65536 characters, and the whole Unicode base plane can be hyphenated
(assuming a proper font encoding). The \PDFTEX\ commands that are not
specific to the PDF output format should work.
\stopitemize

In either mode, I/O translation processes, tcx files, enctex, cannot
be used. The encoding items are superseded by a \LUA-based solution
(\type{reader} callbacks).


\chapter{Basic \TEX\ enhancements}

\section{Unicode support}

Text input and output is now considered to be Unicode text, so
characters can use the full range of Unicode ($2^{20}+2^{16} =
\hbox{\hex10FFFF} = 1114111$). 

For now, it only makes sense to use values above the base plane (\hex
FFFF) for \type{\mathcode} and \type{\catcode} assignments, since the
fonts as well as the hyphenation patterns are still limited to at the
most 16-bit values, so the other command will not know what to do with
those high values.

Many primitives are affected by this. For instance,
\type{\char} now accepts values between 0 and 1114111. This should not
be a problem for well-behaved input files, but it could create
incompatibilities for input that would have generated an error when
processed by older \TEX-based engines.

\starttable[|l|l|l|l|]
\NC Primitive           \NC Bits    \NC Hex    \NC Range                 \NC \FR
\NC \type{\char}        \NC 21      \NC \hex10FFFF \NC ($2^{20}+2^{16}$)      \NC\NR
\NC \type{\chardef}     \NC 21=21   \NC \hex10FFFF=\hex10FFFF   \NC ($2^{20}+2^{16}$) = ($2^{20}+2^{16}$)     \NC\NR
\NC \type{\lccode}      \NC 21=21   \NC \hex10FFFF=\hex10FFFF   \NC ($2^{20}+2^{16}$) = ($2^{20}+2^{16}$)\NC\NR
\NC \type{\uccode}      \NC 21=21   \NC \hex10FFFF=\hex10FFFF   \NC ($2^{20}+2^{16}$) = ($2^{20}+2^{16}$)\NC\NR
\NC \type{\sfcode}      \NC 21=15   \NC \hex10FFFF=\hex7FFF   \NC ($2^{20}+2^{16}$) = ($2^{15}$)\NC\NR
\NC \type{\catcode}     \NC 21=4    \NC \hex10FFFF=\hex F    \NC ($2^{20}+2^{16}$) = ($2^4$)\NC\NR
\NC \type{\mathchardef} \NC 21=15   \NC \hex10FFFF=\hex8000   \NC ($2^{20}+2^{16}$) = ($2^{3}*2^{8}*2^{4}$) \NC\NR
\NC \type{\mathcode}    \NC 21=15   \NC \hex10FFFF=\hex8000   \NC ($2^{20}+2^{16}$) = ($2^{3}*2^{8}*2^{4}$) \NC\NR
\NC \type{\delcode}     \NC 21=27   \NC \hex10FFFF=\hex7FFFFFF   \NC ($2^{20}+2^{16}$) = ($2^{3}*2^{4}*2^{8}*2^{4}*2^{8}$)\NC\NR 
\stoptable

As far as the core engine is aware, all input and output to text files
is UTF-8 encoded. Input files can be preprocessed using the
\callback{reader} callback. This will be explained in a later chapter.

Output to the terminal uses \type{^^} notation for the lower control
range, with the exception of \type{^^I}, \type{^^J} and  \type{^^M}.
These are considered `safe' and therefore printed as-is.

No normalization of the Unicode input takes place yet, but that will
happen eventually.

\section{Wide math characters}

Text is now extended up to the full Unicode range, but math mode deals
mostly with glyphs in fonts directly, and fonts tend to be 16-bit at
maximum.

Therefore, the math primitives from \ALEPH\ are kept mostly as-is,
except for the ones that convert from input to math commands. The
extended commands (with the `\type{o}' prefix) accept 16-bit glyph
indices in one of 256 possible families. The traditional \TEX\
primitives are unchanged, their arguments are upscaled internally.

\starttable[|l|l|l|l|]
\NC Primitive           \NC Bits    \NC Hex    \NC Range                 \NC \FR
\NC \type{\mathchar}    \NC 15      \NC \hex7FFF   \NC ($2^{3}*2^{8}*2^{4}$)  \NC\NR
\NC \type{\delimiter}   \NC 27      \NC \hex7FFFFFF      \NC ($2^{3}*2^{4}*2^{8}*2^{4}*2^{8}$)\NC\NR
\NC \type{\omathchar}   \NC 27      \NC \hex7FFFFFF\NC ($2^{3}*2^{16}*2^{8}$)  \NC\NR
\NC \type{\odelimiter}  \NC 27+24   \NC \hex7FFFFFF+\hex FFFFFF   \NC ($2^{3}*2^{8}*2^{16}$)+($2^{8}*2^{16}$)\NC\NR
\NC \type{\omathchardef}\NC 21=27   \NC \hex10FFFF=\hex8000000   \NC ($2^{20}+2^{16}$) = ($2^{3}*2^{16}*2^{8}$)\NC\NR
\NC \type{\omathcode}   \NC 21=27   \NC \hex10FFFF=\hex8000000   \NC ($2^{20}+2^{16}$) = ($2^{3}*2^{16}*2^{8}$) \NC\NR
\NC \type{\odelcode}    \NC 21=27+24\NC \hex10FFFF=\hex7FFFFFF+ \NC($2^{20}+2^{16}$) = ($2^{3}*2^{8}*2^{16}$)+ \NC\NR
\NC                     \NC         \NC \hphantom{\hex10FFFF= }\hex FFFFFF\NC \hphantom{($2^{20}+2^{16}$) = } ($2^{8}*2^{16}$)\NC\LR
\stoptable

\section{Extended register tables}

All registers can be \type{<16-bit number>}, as in \ALEPH. The
affected commands are:

\startcolumns
\starttyping
\count
\dimen
\skip
\muskip
\marks
\toks
\countdef
\dimendef
\skipdef
\muskipdef
\toksdef
\box
\unhbox
\unvbox
\copy
\unhcopy
\unvcopy
\wd
\ht
\dp
\setbox
\vsplit
\stoptyping
\stopcolumns

\section{Lua related primitives}

In order to merge lua code with \TEX\ input, a few new primitives are
needed. \LUATEX\ has support for 65536 separate lua interpreter
states. States are automatically created based on the integer argument
to the primitives \primitive{directlua} and \primitive{latelua}.

\subsection{\primitive{directlua}}

The primitive \primitive{directlua} is used to execute lua code.
The syntax is
\startsyntax
  \directlua <16-bit number> <general text>
\stopsyntax

The \syntax{<general text>} is fed into the lua interpreter state
indicated by the \syntax{<16-bit number>}. If the state does not exist
yet, then it will be initialized automatically.

This command is expandable. 

\subsection{\primitive{latelua}}

\primitive{latelua} stores lua code in a whatsit that will be processed 
inside the output routine. It is very similar to \type{\pdfliteral}.

Any output it produces should go straight to the PDF file, but at the
moment it is broken (there is no way to generate the desired output)
\startsyntax
  \latelua ["direct"|"page"] <16-bit number> <general text>
\stopsyntax

\subsection{\primitive{luaescapestring}}

This primitive converts a \TEX\ token string so that it can be safely
used as the contents of a \LUA\ string: embedded backslashes, double
quotes and single quotes are escaped by prepending an extra token
consisting of a backslash with catcode 12.
\startsyntax
  \luaescapestring <general text>
\stopsyntax


\subsection{\primitive{luaclose}} 

This primitive allows you to close a lua state, freeing all of its
used memory.

\startsyntax
  \luaclose <16-bit number>
\stopsyntax

You cannot close lua state zero (0), any attempt to do so will be
silently ignored.

States are only closed automatically when a fatal (out of memory)
error occurs, but at that point \LUATEX\ will exit anyway.

\section{New \ETEX\ primitives}

\subsection{\primitive{clearmarks}}

This primitive clears a marks class completely, resetting all three
connected mark texts to empty.
\startsyntax
      \clearmarks <16-bit number>
\stopsyntax

\subsection{\primitive{formatname}}

\primitive{formatname}'s syntax is identical to \type{\jobname}. 

In initex, the expansion is empty. Otherwise, the expansion is the
value that \type{\jobname} had during the initex run that dumped the
currently loaded format.

\subsection{\primitive{scantextokens}}

The syntax of \primitive{scantextokens} is identical to \type{\scantokens}. 

This is a slightly adapted version of \ETEX's \type{\scantokens}. The 
differences are:

\startitemize
\item The last (and usually only) line does not have a
      \type{\endlinechar} appended
\item \type{\scantextokens} never raises an EOF error,
      and it does not execute \type{\everyeof} tokens.
\item The `while end of file' tests are not executed, allowing
      the expansion to end on a different grouping level or while a
      conditional is still incomplete
\stopitemize


\subsection{Catcode tables}

Catcode tables are a new feature that allows you to switch to a
predefined catcode regime in a single statement. You can have a
practically unlimited number of different tables (at this moment up to
268,435,456. The limit depends on an array allocation).

The subsystem is backward compatible: if you never use the following
commands, your document will not notice any difference in behavior
compared to traditional \TEX.

The contents of each catcode table is independent of any other
catcode tables, and their contents is stored and retrieved from the
format file. 

\subsubsection{\primitive{catcodetable}}
\startsyntax
  \catcodetable <28-bit number>
\stopsyntax

The \primitive{catcodetable} switches to a different catcode table.
Such a table has to be previously created using one of the two
primitives below, or it has to be zero (table zero is initialized by
initex)

\subsubsection{\primitive{initcatcodetable}}
\startsyntax
  \initcatcodetable <28-bit number>
\stopsyntax

The \primitive{initcatcodetable} creates a new table with catcodes
identical to those defined by initex:

\starttable[|l|l|l|]
\NC \type{^^M}~(<return>) \NC \type{car_ret}     \NC5 \NC\NR
\NC \type{ }~(space)      \NC \type{spacer}      \NC10\NC\NR
\NC \type{\\}             \NC \type{escape}      \NC0 \NC\NR
\NC \type{%}              \NC \type{comment}     \NC14\NC\NR
\NC \type{^^?}~(<delete>) \NC \type{invalid_char}\NC15\NC\NR
\NC \type{^^@}~(<null>)   \NC \type{ignore}      \NC9 \NC\NR
\NC \type{a}--\type{z}    \NC \type{letter}      \NC11\NC\NR
\NC \type{A}--\type{Z}    \NC \type{letter}      \NC11\NC\NR
\NC everything else       \NC \type{other}       \NC12\NC\NR
\stoptable

The new catcode table is allocated globally: it will not go away after
the current group has ended. If the supplied number is the currently
active table, an error is raised.

\subsubsection{\primitive{savecatcodetable}}
\startsyntax
  \savecatcodetable <28-bit number>
\stopsyntax

\primitive{savecatcodetable} copies the current set of catcodes to a
new table with the requested number. The definitions in this new table
are all treated as if they were made in the outermost level.

The new table is allocated globally: it will not go away after the
current group has ended. If the supplied number is the currently
active table, an error is raised.

\chapter {Lua general}

\section{Initialization}


Whenever the \LUATEX\ executable starts, it looks for a \type{--lua}
or \type{--luaonly} command||line option. If such an option is
present, it will enter an alternative mode of command||line parsing.

In this mode, it will only interpret a very small subset of the
command||line directly:
\starttable[|l|l|]
\NC --luaonly=s  \NC execute a lua script, then exit      \NC \AR
\NC --lua=s      \NC load and execute a lua init script   \NC \AR
\NC --help       \NC display help and exit                \NC \AR
\NC --version    \NC display version and exit             \NC \AR
\stoptable

If a requested lua script can not be found using the actual name given
on the command||line, a second attempt is made by prepending the value
of the environment variable \type{LUATEXDIR}, if that variable is
defined.

Then the script is loaded and executed. It will find the entire
commandline in the table \type{arg}, beginning with \type{arg[0]},
that is the name of the executable. 

In the \type{--luaonly} case and in the case where there is no
discernable input or format file on the command line, \LUATEX\ will
exit immediately after executing the lua script and is, in effect,
a rather bulky standalone lua interpreter.

In the other cases, \LUATEX\ will fetch some of the processed command
line options from the \type{texconfig} table at the end of script
execution (see the description of the \type{texconfig} table later on
in this document).

This happens very early on. So early, in fact, that none of
\TEX's initializations have taken place yet. For that reason, the
\type{tex} and \type{pdf} tables are off-limits during the execution
of the startup file (they are nilled). Special care is taken that
\type{texio.write} and \type{texio.write_nl} function properly, so that
you can at least report your actions to the log file when (and if) it
eventually becomes opened (note that \TEX\ does not even know it's
\type{\jobname} yet at this point).

The file is loaded into Lua state 0, and everything you do will remain
visible during the rest of the run, with the exception of the
\type{tex} and \type{pdf} tables: those will be restored to their
normal meaning right after the execution of the script. 

We recommend you use the startup file only for your own
\TEX-independant initializations (if you need any), to parse the
command||line, set values in the \type{texconfig} table, and
register the callbacks you need.


Unless the \type{texconfig} table tells it not to start kpathsea at
all (set \type{texconfig.kpse_init} to \type{false} for that), it also
acts on three other command||line options:

\starttable[|l|l|]
\NC --fmt=s      \NC set the format name                  \NC \AR
\NC --progname=s \NC set the progname (only for kpathsea) \NC \AR
\NC --ini        \NC enable initex mode                   \NC \AR
\stoptable

In order to initialize the built-in kpathsea library properly,
\LUATEX\ needs to know the correct `progname' to use, and for that it 
needs to check \type{-progname} and \type{-ini} and \type{-fmt}
(if \type{-progname} is missing).

\section{Lua changes}

Three modules that are normally external are statically linked in with
\LUATEX: \type{slnunicode}, \type{luazip}, and \type{luafilesystem}.

The \type{read("*line")} function from the io library has been
adjusted so that it is line-ending neutral: any of \type{LF}, \type
{CR} or type{CR+LF} are accepted.

The \type{tostring()} printer for numbers has been changed so that it
returns `0' instead of something like `2e-5' (which confused \TEX\
enormously) when the value is so small that \TEX\ cannot distinguish
it from zero.

The (currently three) known bugs in Lua 5.1.1 have been patched.

Dynamic loading of \type{.so} and \type{.dll} files is disabled on
all platforms.

\chapter{Lua Libraries}

The interfacing between \TEX\ and \LUA\ is facilitated by a set of
\LUA\ modules.

\section{The \lualib{tex} library}

The \lualib{tex} table contains a large list of virtual internal \TEX\
parameters that are partially writable.

The designation `virtual' means that these items are not properly
defined in Lua, but are only frontends that are handled by a metatable
that operates on the actual \TEX\ values. As a result, most of the lua
table operators (like \type{pairs} and \type{#}) do not work on such
items.


At the moment, it is possible to access almost every parameter
that has these characteristics:
\startitemize
\item You can use it after \type{\the} 
\item It is a single token. 
\stopitemize
This excludes parameters that need extra arguments, like
\type{\the\scriptfont}.

The subset comprising simple integer and dimension registers are
writable as well as readable (stuff like \type{\tracingcommands} and
\type{\parindent}).

\subsection{Integer parameters}

The integer parameters accept and return lua numbers.

Read-write:

\startcolumns
\starttyping
tex.adjdemerits
tex.binoppenalty
tex.brokenpenalty
tex.catcodetable
tex.clubpenalty
tex.day
tex.defaulthyphenchar
tex.defaultskewchar
tex.delimiterfactor
tex.displaywidowpenalty
tex.doublehyphendemerits
tex.endlinechar
tex.errorcontextlines
tex.escapechar
tex.exhyphenpenalty
tex.fam
tex.finalhyphendemerits
tex.floatingpenalty
tex.globaldefs
tex.hangafter
tex.hbadness
tex.holdinginserts
tex.hyphenpenalty
tex.interlinepenalty
tex.language
tex.lastlinefit
tex.lefthyphenmin
tex.linepenalty
tex.localbrokenpenalty
tex.localinterlinepenalty
tex.looseness
tex.mag
tex.maxdeadcycles
tex.month
tex.newlinechar
tex.outputpenalty
tex.pausing
tex.pdfadjustinterwordglue
tex.pdfadjustspacing
tex.pdfappendkern
tex.pdfcompresslevel
tex.pdfdecimaldigits
tex.pdfforcepagebox
tex.pdfgamma
tex.pdfgentounicode
tex.pdfimageapplygamma
tex.pdfimagegamma
tex.pdfimagehicolor
tex.pdfimageresolution
tex.pdfinclusionerrorlevel
tex.pdfminorversion
tex.pdfmovechars
tex.pdfobjcompresslevel
tex.pdfoptionalwaysusepdfpagebox
tex.pdfoptionpdfinclusionerrorlevel
tex.pdfoptionpdfminorversion
tex.pdfoutput
tex.pdfpagebox
tex.pdfpkresolution
tex.pdfprependkern
tex.pdfprotrudechars
tex.pdftracingfonts
tex.pdfuniqueresname
tex.postdisplaypenalty
tex.predisplaydirection
tex.predisplaypenalty
tex.pretolerance
tex.relpenalty
tex.righthyphenmin
tex.savinghyphcodes
tex.savingvdiscards
tex.showboxbreadth
tex.showboxdepth
tex.time
tex.tolerance
tex.tracingassigns
tex.tracingcommands
tex.tracinggroups
tex.tracingifs
tex.tracinglostchars
tex.tracingmacros
tex.tracingnesting
tex.tracingonline
tex.tracingoutput
tex.tracingpages
tex.tracingparagraphs
tex.tracingrestores
tex.tracingscantokens
tex.tracingstats
tex.uchyph
tex.vbadness
tex.widowpenalty
tex.year
\stoptyping
\stopcolumns

Read-only:

\startcolumns
\starttyping
tex.deadcycles
tex.insertpenalties
tex.parshape
tex.prevgraf
tex.spacefactor
\stoptyping
\stopcolumns


\subsection{Dimension parameters}

The dimension parameters accept lua numbers (signifying scaled points)
or strings (with included dimension). The result is always a string.

Read-write:

\startcolumns
\starttyping
tex.boxmaxdepth
tex.delimitershortfall
tex.displayindent
tex.displaywidth
tex.emergencystretch
tex.hangindent
tex.hfuzz
tex.hoffset
tex.hsize
tex.lineskiplimit
tex.mathsurround
tex.maxdepth
tex.nulldelimiterspace
tex.overfullrule
tex.pagebottomoffset
tex.pageheight
tex.pagerightoffset
tex.pagewidth
tex.parindent
tex.pdfdestmargin
tex.pdfeachlinedepth
tex.pdfeachlineheight
tex.pdffirstlineheight
tex.pdfhorigin
tex.pdflastlinedepth
tex.pdflinkmargin
tex.pdfpageheight
tex.pdfpagewidth
tex.pdfpxdimen
tex.pdfthreadmargin
tex.pdfvorigin
tex.predisplaysize
tex.scriptspace
tex.splitmaxdepth
tex.vfuzz
tex.voffset
tex.vsize
\stoptyping
\stopcolumns

Read-only:

\startcolumns
\starttyping
tex.pagedepth
tex.pagefilllstretch
tex.pagefillstretch
tex.pagefilstretch
tex.pagegoal
tex.pageshrink
tex.pagestretch
tex.pagetotal
tex.prevdepth
\stoptyping
\stopcolumns

\subsection{Direction parameters}

All direction parameters are read-only and return a lua string

\startcolumns
\starttyping
tex.bodydir
tex.mathdir
tex.pagedir
tex.pardir
tex.textdir
\stoptyping
\stopcolumns

\subsection{Glue parameters} 

All glue parameters are read-only and return a lua string

\startcolumns
\starttyping
tex.abovedisplayshortskip
tex.abovedisplayskip
tex.baselineskip
tex.belowdisplayshortskip
tex.belowdisplayskip
tex.leftskip
tex.lineskip
tex.parfillskip
tex.parskip
tex.rightskip
tex.spaceskip
tex.splittopskip
tex.tabskip
tex.topskip
tex.xspaceskip
\stoptyping
\stopcolumns

\subsection{Muglue parameters}

All muglue parameters are read-only and return a lua string

\starttyping
tex.medmuskip
tex.thickmuskip
tex.thinmuskip
\stoptyping

\subsection{Tokenlist parameters}

All tokenlist parameters are read-only and return a lua string

\startcolumns
\starttyping
tex.errhelp
tex.everycr
tex.everydisplay
tex.everyeof
tex.everyhbox
tex.everyjob
tex.everymath
tex.everypar
tex.everyvbox
tex.output
tex.pdfpageattr
tex.pdfpageresources
tex.pdfpagesattr
tex.pdfpkmode
\stoptyping
\stopcolumns

\subsection{Convert commands}

The supported commands at this moment are:

\startcolumns
\starttyping
tex.AlephVersion
tex.Alephrevision
tex.OmegaVersion
tex.Omegarevision
tex.eTeXVersion
tex.eTeXrevision
tex.formatname
tex.jobname
tex.pdfnormaldeviate
tex.pdftexbanner
tex.pdftexrevision
\stoptyping
\stopcolumns

All `convert' commands are read-only and return a lua string

This list looks haphazard, but it really is not. These are all the
cases of the `convert' internal command that do not require an
argument. 

\subsection{Count, dimension and token registers}

\TeX's counters (\type{\count}), dimensions (\type{\dimen}) and token
(\type{\toks}) registers can be accessed and written to using three
virtual sub-tables of the \type{tex} table:

\starttyping
    tex.count
    tex.dimen
    tex.toks
\stoptyping

It is possible to use the names of relevant \type{\countdef},
\type{\dimendef}, or \type{\toksdef} control sequences as indices 
to these tables:

\starttyping
    tex.count.scratchcounter = 0
    enormous = tex.dimen["maxdimen"]
\stoptyping

In this case, luatex looks up the value for you on the fly. You have
to use a valid \type{\countdef} (or \type{\dimendef}, or
\type{\toksdef}), anything else will generate an error 
(the goal is to eventually also allow \type{<chardef tokens>} and
even macros that expand into a number)

The count registers accept and return lua numbers.

The dimension registers accept lua numbers (in scaled points)
or strings (with included dimension). The result is always a number
in scaled points.

The token registers accept and return lua strings. Lua strings are
converted to token lists using \type{\the\toks} style expansion.

As an alternative to array addressing, there are also accessor
functions defined:

\startfunctioncall
  tex.setdimen(number n, string s)
  tex.setdimen(string s, string s)
  tex.setdimen(number n, number n)
  tex.setdimen(string s, number n)
  number n = tex.getdimen(number n)
  number n = tex.getdimen(string s)

  tex.setcount(number n, number n)
  tex.setcount(string s, number n)
  number n = tex.getcount(number n)
  number n = tex.getcount(string s)

  tex.settoks (number n, string s)
  tex.settoks (string s, string s)
  string s = tex.gettoks (number n)
  string s = tex.gettoks (string s)
\stopfunctioncall

\subsection{Box register size information}

The current dimensions of \type{\box} registers can be read and
altered using three other virtual sub-tables :

\starttyping
    tex.wd
    tex.ht
    tex.dp
\stoptyping

These are indexed strictly by number.

The box size registers accept lua numbers (in scaled points)
or strings (with included dimension). The result is always a number
in scaled points.


As an alternative to array addressing, there are also accessor
functions defined:

\startfunctioncall
  tex.setboxwd(number n, string s)
  tex.setboxwd(number n, number n)
  number n = tex.getboxwd(number n)

  tex.setboxht(number n, string s)
  tex.setboxht(number n, number n)
  number n = tex.getboxht(number n)

  tex.setboxdp(number n, string s)
  tex.setboxdp(number n, number n)
  number n = tex.getboxdp(number n)
\stopfunctioncall


\subsection{Print functions}

The \type{tex} table also contains the three print functions that
are the major interface from lua scripting to \TEX. 

The arguments to these three functions are all stored in an in-memory
virtual file that is fed to the \TEX\ scanner as the result of the
expansion of \type{\directlua}.

The total amount of returnable text from a \type{\directlua} command
is only limited by available system RAM. However, each separate
printed string has to fit completely in \TEX's input buffer.

\subsubsection{\function{tex.print}}

\startfunctioncall
   tex.print(<string s>, ...)
   tex.print(<number n>, <string s>, ...)
\stopfunctioncall

Each string argument is treated by \TEX\ as a separate input line.

The optional parameter can be used to print the strings using the
catcode regime defined by \type{\catcodetable} $n$. If $n$ is not
a valid catcode table, then it is ignored, and the currently
active catcode regime is used instead.

The very last string of the very last \type{tex.print()} command in a
\type{\directlua} will not have the \type{\endlinechar} appended, all 
others do.

\subsubsection{\function{tex.sprint}}

\startfunctioncall
   tex.sprint(<string s>, ...)
   tex.sprint(<number n>, <string s>, ...)
\stopfunctioncall

Each string argument is treated by \TEX\ as a special kind of input line
that makes it suitable for use as a partial line input mechanism:

\startitemize
\item \TEX\ does not switch to the `new line' state, so 
   that leading spaces are not ignored
\item no \type{\endlinechar} is inserted
\item trailing spaces are not removed
\stopitemize

\subsubsection{\function{tex.write}}

\startfunctioncall
   tex.write(<string s>, ...)
\stopfunctioncall

Each string argument is treated by \TEX\ as a special kind of input
line that makes is suitable for use as a quick way to dump
information:

\startitemize
\item all catcodes on that line are either `space' (for " ") or
     `character' (for all others).
\item there is no \type{\endlinechar} appended.
\stopitemize


\section{The \lualib{texio} library}

This library takes care of the low-level I/O interface.

\subsection{Printing functions}

\subsubsection{\function{texio.write}}

\startfunctioncall
  texio.write(string target, tring s)
  texio.write(string s)
\stopfunctioncall

Without the \type{target} argument, Writes the string to the same
location(s) \TEX\ writes messages to at this moment. If
\type{\batchmode} is in effect, it writes only to the log, 
otherwise  it writes to the log and the terminal.

The optional \type{target} can be one of three possibilities:
`term', `log' or `term and log'.

\subsubsection{\function{tex.write_nl}}

\startfunctioncall
  texio.write_nl(string target, tring s)
  texio.write_nl(string s)
\stopfunctioncall

Like \function{texio.write}, but make sure that the string s will
appear at the beginning of a line. You can use an empty string if you
only want to move to the next line.

\section{The \lualib{pdf} library}

This table contains the current \type{h} en \type{v} values that
define the location on the output page. The values can be queried 
and set using scaled points as units.

\starttyping
    pdf.v
    pdf.h
\stoptyping   

The associated function calls are

\startfunctioncall
     pdf.setv(number n)
     number n = pdf.getv()
     pdf.seth(number n)
     number n = pdf.geth()
\stopfunctioncall

\section{The \lualib{callback} library}

This library has a function that is used to register callbacks, and a
function that lists the registered callbacks

The \lualib{callback} library is only available in lua state zero (0).

\startfunctioncall
   callback.register(string <callback name>,function <callback_func>)
   callback.register(string <callback name>,nil)
\stopfunctioncall

where the \syntax{<callback name>} is a predefined callback name, see
below.

\LUATEX\ internalizes the callback function in such a way that
it does not matter if you redefine a function accidentally.

Callback assignments are always global. You can use the special value
`nil' instead of a function for clearing the callback.

\startfunctioncall
   table <info> = callback.list()
\stopfunctioncall

The keys in the table are the known callback names, the value is a
boolean where \type{true} means that the callback is currently set
(active).

\subsection{File discovery callbacks}


\subsubsection{\callback{find_read_file} and \callback{find_write_file}}

You callback function should have the following conventions:

\startfunctioncall
   string <actual_name> = function (number <id_number>, string <asked_name>)
\stopfunctioncall

Arguments:
\startitemize
\sym{id_number}   

zero for the log or \type{\input} files, or TeX's \type{\read} or
\type{\write} number incremented by one (\type{\read}0 becomes 1).

\sym{asked_name}

the user||supplied filename, as found by \type{\input}, or \type{\openin},
or \type{\openout}.
\stopitemize

Return value:
\startitemize

\sym{actual_name} 

the filename used. For the very first file that is read in by \TEX,
you have to make sure you return an \type{actual_name} that has an
extension and that is suitable for use as \type{jobname}. If you
don't, you will have to manually fix the name for the log file and
output file, and an eventual format filename will become mangled,
since these depend on the jobname.

\stopitemize

\subsubsection{\callback{find_font_file}}

You callback function should have the following conventions:

\startfunctioncall
   string <actual_name> = function (string <asked_name>)
\stopfunctioncall

The  \type{asked_name} is an OTF or TFM font metrics file.


\subsubsection{\callback{find_output_file}}

You callback function should have the following conventions:

\startfunctioncall
   string <actual_name> = function (string <asked_name>)
\stopfunctioncall

The  \type{asked_name} is the PDF or DVI file for writing.

\subsubsection{\callback{find_format_file}}

You callback function should have the following conventions:

\startfunctioncall
   string <actual_name> = function (string <asked_name>)
\stopfunctioncall

The \type{asked_name} is a format file for reading (the format file
for writing is always opened in the current directory).

\subsubsection{\callback{find_truetype_file} and \callback{find_type1_file}}

You callback function should have the following conventions:

\startfunctioncall
   string <actual_name> = function (string <asked_name>)
\stopfunctioncall

The \type{asked_name} is a font file. This callback is called while
\LUATEX\ is building its internal list of needed font files, so the
actual timing may surprise you. Your return value is later fed back
into the matching \callback{read__file} callback.

Strangely enough, \type{find_type1_file} is also used for OpenType
(otf) fonts.

\subsubsection{\callback{find_image_file}}

You callback function should have the following conventions:

\startfunctioncall
   string <actual_name> = function (string <asked_name>)
\stopfunctioncall

The \type{asked_name} is an image file. Your return value is used to
open a file from the harddisk, so make sure you return something that
is considered the name of a valid file by your operating system.


\subsection{File reading callbacks}

\subsubsection{\callback{open_read_file}}

You callback function should have the following conventions:

\startfunctioncall
   table <env> = function (string <file_name>)
\stopfunctioncall

Argument:
\startitemize
\sym{file_name}

the filename returned by a previous \callback{find_read_file} or the return
value of \type{kpse_find_file()} if there was no such callback defined.
\stopitemize

Return value:
\startitemize
\sym{env}  

this is a table containing one required and one optional callback
functions for this file. The required field is `\callback{reader}' and
the associated function will be called once for each new line to be
read, the optional one is `\callback{close}' that will be called once
when \LUATEX\ is done with the file.

Neither function will receive an argument, so you should set you a
proper closure for them.
\stopitemize

\subsubsubsection{\callback{reader}}

\LUATEX\ will run this function whenever it needs a new input line 
from the file.

\startfunctioncall
  function ()
    return string <line>
  end
\stopfunctioncall

Your function should return either a string or `nil'. The value `nil'
signals that the end of file has occurred, and will make \TEX\ call
the optional `\callback{close}' function next.

\subsubsubsection{\callback{close}}

\LUATEX\ will optionally run this function when it needs to close the file.

\startfunctioncall
  function ()
    return
  end
\stopfunctioncall

Your function should not return any value.

\subsubsection{\callback{read_font_file}}

This function is called when \TEX\ needs to read a \type{ofm} or
\type{tfm} file.

\startfunctioncall
     function (string <name>)
        return boolean <success>, string <data>, number <data_size>
     end
\stopfunctioncall

\startitemize
\sym{success} 

return false when the file cannot be found.

\sym{data} 

the bytes comprising the file. 

\sym{data_size} 

the length of the \type{data}, in bytes.
\stopitemize

return an empty string and zero if the file was found but there was a
reading problem.

\subsubsection{\callback{read_vf_file}}

Like \callback{read_font_file}, but for virtual fonts.

\subsubsection{\callback{read_ocp_file}}

Like \callback{read_font_file}, but for ocp files.

\subsubsection{\callback{read_map_file}}

Like \callback{read_font_file}, but for map files.

\subsubsection{\callback{read_enc_file}}

Like \callback{read_font_file}, but for enc files.


\subsubsection{\callback{read_sfd_file}}

Like \callback{read_font_file}, but for subfont definition files.


\subsubsection{\callback{read_miscfonts_file}}

Like \callback{read_font_file}, but for t3 font (pgc) files.


\subsubsection{\callback{read_pk_file}}

Like \callback{read_font_file}, but for pk bitmap files. The argument
\type{<name>} is a bit special in this case. It's form is

\starttyping
  <base res>dpi/<fontname>.<actual res>pk
\stoptyping

So you may be asked for \type{600dpi/manfnt.720pk}.  It is up to you
to find a `reasonable' bitmap file to go with that specification.

\subsubsection{\callback{read_data_file}}

Like \callback{read_font_file}, but for embedded files (\type{\pdfobj file "..."}).


\subsubsection{\callback{read_truetype_file}}

Like \callback{read_font_file}, but for truetype font files. The
\type{name} is a path name as returned by \callback{find_truetype_file} 
or \type{kpse_find_file}.

\subsubsection{\callback{read_type1_file}}

Like \callback{read_font_file}, but for type1 font files. The
\type{name} is a path name as returned by \callback{find_type1_file} 
or \type{kpse_find_file}.

\subsubsection{\callback{read_opentype_file}}

Like \callback{read_font_file}, but for opentype font files. The
\type{name} is a path name as returned by \callback{find_type1_file} 
or \type{kpse_find_file}.

\subsection{Information reporting callbacks}


\subsubsection{\callback{start_run}}

\startfunctioncall
  function ()
\stopfunctioncall

Replaces the code that prints \LUATEX's banner

\subsubsection{\callback{stop_run}}

\startfunctioncall
  function ()
\stopfunctioncall

Replaces the code that prints \LUATEX's statistics and `Output written
to' messages.

\subsubsection{\callback{start_page_number}}

\startfunctioncall
  function ()
\stopfunctioncall

Replaces the code that prints the \type{[} and the page number at the
begin of \type{\shipout}. This callback will also override the
printing of box information that normally takes place when
\type{\tracingoutput} is positive.

\subsubsection{\callback{stop_page_number}}

\startfunctioncall
  function ()
\stopfunctioncall

Replaces the code that prints the \type{]} at the end of \type{\shipout}

\subsubsection{\callback{show_error_hook}}
       
\startfunctioncall
     function (string <message>, string <indicator>, number <lineno>)
     return end function (string <message>, number <indicator>, number
     <lineno>) return end
\stopfunctioncall

This callback is run from inside the \TEX\ error function, and the idea
is to allow you to do some extra reporting on top of what \TEX\ already
does (none of the normal actions are removed).

\startitemize
\sym{message} 

is the formal error message \TEX\ has given to the user
(the line after the "! ")

\sym{indicator} 

is either a filename (when it is a string) or a location indicator (a
number) that can means lots of different things like a token list id
or a \type{\read} number.

\sym{lineno}  

is the current line number
\stopitemize

This is an investigative item only, only for 'testing the water'.

The final goal is the total replacement of \TEX's error handling
routines, but that needs lots of adjustments in the web source because
\TEX\ deals with errors in a somewhat haphazard fashion.

\section{The \lualib{lua} library}

This library contains two read-only  items:

\subsection{Variables}

\starttyping
     number n = lua.id
\stoptyping
the id number of the instance


\starttyping
     string s = lua.version
\stoptyping 
a luatex version identifier string (currently \type{"0.1"})

\subsection{Lua bytecode registers}

Lua registers can be used to communicate lua functions across lua
states. The accepted values for assignments are functions and
nil. Likewise, the retrieved value is either a function or nil.

\starttyping
     lua.bytecode[n] = function () .. end
     lua.bytecode[n]()
\stoptyping

The contents of the \type{lua.bytecode} array is stored inside the format
file as actual lua bytecode, so it can also be used to preload lua code.

The associated function calls are

\startfunctioncall
     function f = lua.getbytecode(number n)
     lua.setbytecode(number n, function f)
\stopfunctioncall


\section{The \lualib{kpse} library}

\subsection{\function{kpse.find_file}}

The most important function in the library is find_file:

\startfunctioncall
 string f = kpse.find_file(string filename)
 string f = kpse.find_file(string filename, string ftype)
 string f = kpse.find_file(string filename, boolean mustexist)
 string f = kpse.find_file(string filename, string ftype, boolean mustexist)
\stopfunctioncall


Arguments:
\startitemize
\sym{filename} 

the name of the file you want to find, with or without extension.

\sym{type} 

maps to the '-format' argument of \type{kpsewhich}.  The supported
values are:

\startcolumns
\starttyping
"gf"
"pk"
"bitmap font"
"tfm" 
"afm" 
"base" 
"bib" 
"bst" 
"cnf"
"ls-R"
"fmt"
"map"
"mem"
"mf" 
"mfpool" 
"mft" 
"mp" 
"mppool" 
"MetaPost support"
"ocp"
"ofm" 
"opl"
"otp"
"ovf"
"ovp"
"graphic/figure"
"tex"
"TeX system documentation"
"texpool"
"TeX system sources"
"PostScript header"
"Troff fonts"
"type1 fonts" 
"vf"
"dvips config"
"ist"
"truetype fonts"
"type42 fonts"
"web2c files"
"other text files"
"other binary files"
"misc fonts"
"web"
"cweb"
"enc files"
"cmap files"
"subfont definition files"
"opentype fonts"
"pdftex config"
"lig files"
"texmfscripts"
\stoptyping
\stopcolumns

The default type is \type{"tex"}.

\sym{mustexist} 

is similar to kpsewhich's '-must-exist', and the default is `false'.
If you specify `true' (or a non-zero integer), then the kpse library
will search the disk as well as the ls-R databases.
\stopitemize

\subsection{\function{kpse.expand_path}}

Like kpsewhich's  `-expand-path':

\startfunctioncall
     string r = kpse.expand_path(string s)
\stopfunctioncall

\subsection{\function{kpse.expand_var}}

Like kpsewhich's  `-expand-var':

\startfunctioncall
     string r = kpse.expand_var(string s)
\stopfunctioncall


\subsection{\function{kpse.expand_braces}}

Like kpsewhich's  `-expand-braces':

\startfunctioncall
     string r = kpse.expand_braces(string s)
\stopfunctioncall

\section{The \lualib{statistics} library}

This contains a number of run||time configuration items that
you may find useful in message reporting, as well as an iterator
function that gets all of the names and values as a table.

\startfunctioncall
   table <info> = statistics.list()
\stopfunctioncall

The keys in the table are the known items, the value is the current
value. 

Almost all of the values in \type{statistics} are fetched through a
metatable at run||time whenever they are accessed, so you cannot use
\type{pairs} on\type{statistics}, but you {\it can\/} use \type{pairs}
on \type{<info>}, of course.

If you do not need the full list, you can also ask for a single item
by using it's name as an index into \type{statistics}. 

The current list is:

\starttabulate[|l|l|]
\NC Key     \NC                  Explanation \NC\FR
\NC pdf_gone\NC                  written pdf bytes      \NC \AR
\NC pdf_ptr\NC                   not yet written pdf bytes      \NC \AR
\NC dvi_gone\NC                  written dvi bytes      \NC \AR
\NC dvi_ptr\NC                   not yet written dvi bytes      \NC \AR
\NC total_pages\NC               number of written pages      \NC \AR
\NC output_file_name\NC          name of the pdf or dvi file      \NC \AR
\NC log_name\NC                  name of the log file      \NC \AR
\NC banner\NC                    terminal display banner      \NC \AR
\NC pdftex_banner\NC             --      \NC \AR
\NC var_used\NC                  variable (one-word) memory in use \NC \AR
\NC dyn_used\NC                  token (multi-word) memory in use  \NC \AR
\NC str_ptr\NC                   number of strings      \NC \AR
\NC init_str_ptr\NC              number of initex strings      \NC \AR
\NC max_strings\NC               maximum allowed strings      \NC \AR
\NC pool_ptr\NC                  string pool index      \NC \AR
\NC init_pool_ptr\NC             initex string pool index      \NC \AR
\NC pool_size\NC                 maximum allowed string characters      \NC \AR
\NC lo_mem_max\NC                current top of multi-word memory      \NC \AR
\NC mem_min\NC                   bottom index of memory array     \NC \AR
\NC mem_end\NC                   top index of memory array      \NC \AR
\NC hi_mem_min\NC                current bottom of one-word memory      \NC \AR
\NC cs_count\NC                  number of control sequences      \NC \AR
\NC hash_size\NC                 size of hash       \NC \AR
\NC hash_extra\NC                extra allowed hash  \NC \AR
\NC font_ptr\NC                  number of active fonts      \NC \AR
\NC hyph_count\NC                hyphenation exceptions      \NC \AR
\NC hyph_size\NC                 max used hyphenation exceptions  \NC \AR
\NC max_in_stack\NC              max used input stack entries      \NC \AR
\NC max_nest_stack\NC            max used nesting stack entries     \NC \AR
\NC max_param_stack\NC           max used parameter stack entries     \NC \AR
\NC max_buf_stack\NC             max used buffer position      \NC \AR
\NC max_save_stack\NC            max used save stack entries      \NC \AR
\NC stack_size\NC                input stack size      \NC \AR
\NC nest_size\NC                 nesting stack size      \NC \AR
\NC param_size\NC                parameter stack size      \NC \AR
\NC buf_size\NC                  line buffer size      \NC \AR
\NC save_size\NC                 save stack size      \NC \AR
\NC obj_ptr\NC                   max pdf object pointer      \NC \AR
\NC obj_tab_size\NC              pdf object table size      \NC \AR
\NC pdf_os_cntr\NC               max pdf object stream pointer      \NC \AR
\NC pdf_os_objidx\NC             pdf object stream index \NC \AR
\NC pdf_dest_names_ptr\NC        max pdf destination pointer       \NC \AR
\NC dest_names_size\NC           pdf destination table size      \NC \AR
\NC pdf_mem_ptr\NC               max pdf memory used      \NC \AR
\NC pdf_mem_size\NC              pdf memory size      \NC \AR
\NC biggest_used_mark\NC         max referenced marks class      \NC \AR
\stoptabulate


\section{The \lualib{texconfig} table}

This is a table that is created empty. A startup lua script could
fill this table with a number of settings that are read out by
the executable after loading and executing the startup file. 


\starttabulate[|l|l|l|p|]
\NC key      \NC type     \NC default \NC explanation \NC\FR
\NC mem_bot \NC 	        number\NC  0\NC cf. web2c docs \NC \AR     
\NC main_memory \NC        number\NC  250000\NC cf. web2c docs \NC \AR
\NC extra_mem_top \NC      number\NC  0\NC cf. web2c docs \NC \AR     
\NC extra_mem_bot \NC      number\NC  0\NC cf. web2c docs \NC \AR     
\NC pool_size \NC 	        number\NC  100000\NC cf. web2c docs \NC \AR
\NC string_vacancies \NC   number\NC  75000\NC cf. web2c docs \NC \AR 
\NC pool_free \NC 	        number\NC  5000\NC cf. web2c docs \NC \AR  
\NC max_strings \NC        number\NC  15000\NC cf. web2c docs \NC \AR 
\NC strings_free \NC       number\NC  100\NC cf. web2c docs \NC \AR   
\NC trie_size \NC 	        number\NC  20000\NC cf. web2c docs \NC \AR 
\NC hyph_size \NC 	        number\NC  659\NC cf. web2c docs \NC \AR   
\NC buf_size \NC 	        number\NC  3000\NC cf. web2c docs \NC \AR  
\NC nest_size \NC 	        number\NC  50\NC cf. web2c docs \NC \AR    
\NC max_in_open \NC        number\NC  15\NC cf. web2c docs \NC \AR    
\NC param_size \NC         number\NC  60\NC cf. web2c docs \NC \AR    
\NC save_size \NC 	        number\NC  4000\NC cf. web2c docs \NC \AR  
\NC stack_size \NC         number\NC  300\NC cf. web2c docs \NC \AR   
\NC dvi_buf_size \NC       number\NC  16384\NC cf. web2c docs \NC \AR 
\NC error_line \NC         number\NC  79\NC cf. web2c docs \NC \AR    
\NC half_error_line \NC    number\NC  50\NC cf. web2c docs \NC \AR    
\NC max_print_line \NC     number\NC  79\NC cf. web2c docs \NC \AR    
\NC ocp_list_size \NC      number\NC 1000\NC cf. web2c docs \NC \AR   
\NC ocp_buf_size \NC       number\NC 1000\NC cf. web2c docs \NC \AR   
\NC ocp_stack_size \NC     number\NC 1000\NC cf. web2c docs \NC \AR   
\NC hash_extra \NC         number\NC  0\NC cf. web2c docs \NC \AR     
\NC pk_dpi \NC             number\NC  72\NC cf. web2c docs \NC \AR    
\NC kpse_init \NC boolean \NC true    \NC \type{false} totally disables Kpathsea initialisation
                                          (only ever unset this if you implement {\it all\/} file
                                          find callbacks!)\NC\AR
\NC trace_file_names \NC boolean \NC true \NC \type{false} disables TeX's normal file open||close 
                                              feedback (the assumption is that callbacks will take care of 
	                                      that). \NC \AR
\NC src_special_auto  \NC boolean \NC false \NC Source specials sub-item \NC\AR
\NC src_special_everypar  \NC boolean \NC false \NC Source specials sub-item \NC\AR
\NC src_special_everyparend  \NC boolean \NC false \NC Source specials sub-item \NC\AR
\NC src_special_everycr  \NC boolean \NC false \NC Source specials sub-item \NC\AR
\NC src_special_everymath  \NC boolean \NC false \NC Source specials sub-item \NC\AR
\NC src_special_everyhbox  \NC boolean \NC false \NC Source specials sub-item \NC\AR
\NC src_special_everyvbox  \NC boolean \NC false \NC Source specials sub-item \NC\AR
\NC src_special_everydisplay  \NC boolean \NC false \NC Source specials sub-item \NC\AR

\NC file_line_error  \NC boolean \NC false \NC Do \type{file:line} style error messages\NC\AR
\NC halt_on_error    \NC boolean \NC false \NC Abort run on the first encountered error\NC\AR
\stoptabulate



\chapter{Modifications}

Besides the expected changes caused by new functionality, there are a
number of not-so-expected changes. These are sometimes a side-effect
of a new (conflicting) feature, or, more often than not, a change
necessary to clean up the internal interfaces.


\section{Changes from \TEX\ 3.141592}

\startitemize

\item There is no pool file, all strings are embedded during compilation.

\item "plus 1 fillll" does not generate an error. The extra `l' is
simply typeset.

\stopitemize


\section{Changes from \ETEX\ 2.2}

\startitemize
\item The \ETEX\ functionality is always present and enabled
   (but see below about \TEXXET), so the prepended asterisk or
   \type{-etex} switch for initex is not needed. 

\item \TEXXET\ is not present, so the primitives
\starttyping
    \TeXXeTstate
    \beginR
    \beginL
    \endR
    \endL
\stoptyping
   are missing

\stopitemize

\section{Changes from \PDFTEX\ 1.40}

\startitemize
\item A number of `utility functions' is removed:
\starttyping
    \pdfelapsedtime
    \pdfescapehex
    \pdfescapename
    \pdfescapestring
    \pdffiledump
    \pdffilemoddate
    \pdffilesize
    \pdflastmatch
    \pdfmatch
    \pdfmdfivesum
    \pdfresettimer
    \pdfshellescape
    \pdfstrcmp
    \pdfunescapehex
\stoptyping

\item A few other experimental primitives are provided without the
      extra  `pdf' prefix, so they are simply called:
\starttyping
    \primitive
    \ifprimitive
    \ifabsnum
    \ifabsdim
\stoptyping

\stopitemize

\section{Changes from \ALEPH\ RC4}

\startitemize
\item The input translations from \ALEPH\ are not implemented, the
   related primitives are not available

\starttyping
    \DefaultInputMode
    \noDefaultInputMode
    \noInputMode
    \InputMode
    \DefaultOutputMode
    \noDefaultOutputMode
    \noOutputMode
    \OutputMode
    \DefaultInputTranslation
    \noDefaultInputTranslation
    \noInputTranslation
    \InputTranslation
    \DefaultOutputTranslation
    \noDefaultOutputTranslation
    \noOutputTranslation
    \OutputTranslation
\stoptyping

\item A small series of bounds checking fixes to \type{\ocp} and 
   \type{\ocplist} has been added to prevent the system from crashing
   due to array indexes running out of bounds.

\item The \type{\hoffset} bug when \type{\pagedir TRT}  is fixed,
removing the need for an explicit fix to \type{\hoffset}

\item A bug causing \type{\fam} to fail for family numbers above
    15 is fixed.

\item Some bits of \ALEPH\ assumed \type{0} and \type{null} were identical.
This resulted for instance in a bug that sometimes caused an eternal
loop when trying to \type{\show} a box.

\item A fair amount of minor bugs are fixed as well, most of these
related to \type{\tracingcommands} output.

\item The number of possible fonts, ocps and ocplists is 
smaller than their maximum \ALEPH\ value (around 500 fonts and 
30000 ocps / ocplists).

\stopitemize

\section{Changes from standard \WEBC}

\startitemize

\item There is no mltex 

\item There is no enctex

\item The following command-line switches are silently ignored:
\starttyping
  -8bit
  -translate-file=TCXNAME
  -mltex
  -enc
  -etex
\stoptyping

\item \type{\openout} whatsits are not written to the log file.

\item Some of the so||called web2c extensions are hard to set up 
  in non-kpse mode because texmf.cnf is not read: \type{shell-escape}
  is off (but that is not a problem because of Lua's
  \type{os.execute}), and the paranoia checks on \type{openin} and
  \type{openout} do not happen (however, it is easy for a Lua script
  to do this itself by overloading \type{io.open}).

\stopitemize

\chapter{Implementation notes}

\subsection{Primitives overlap}

The primitives
\starttyping
      \pdfpagewidth and \pagewidth,
      \pdfpageheight and \pageheight,
      \fontcharwd and \charwd,
      \fontcharht and \charht,
      \fontchardp and \chardp,
      \fontcharic and \charic,
\stoptyping
are all aliases of each other.

\subsection{Sparse arrays}

The \type{\mathcode}, \type{\delcode}, \type{\catcode},
\type{\sfcode}, \type{\lccode} and \type{\uccode} tables are now
sparse arrays that are implemented in C. They are no longer part of
the \TEX\ ``equivalence table'' and because each had 1.1 million
entries with a few memory words each, this makes a major difference
in memory usage.

These assignments do not yet show up when using the etex tracing
routines \type{\tracingassigns} and \type{\tracingrestores} (code
simply not written yet)

A side-effect of the current implementation is that \type{\global} is
now more expensive in terms of processing than non-global assignments.

See \type{mathcodes.c} and \type{textcodes.c} if you are interested in
the gory details.

\subsection{Simple single-character csnames}

Single-character commands are no longer treated special in the
internals, they are stored in the hash just like the multiletter
csnames. 

The code that displays control sequences explicitly checks if
the length is one when it has to decide whether or not to add a
trailing space.

\subsection{Compressed format}

The format is passed through zlib, allowing it to shrink to roughly a
third of the size it would have had in uncompressed form. This takes a
bit more CPU cycles but much less disk I/O, so it should still be
faster. 

The chosen compression factor is fairly low, equivalent to \type{gzip -3}.

\subsection{Binary file reading}

All of the internal code is changed in such a way that if one of the
\type{read_xxx_file} callbacks is not set, then the file is read by
a C function using basically the same convention as the callback: a
single read into a buffer big enough to hold the entire file
contents. While this uses more memory than the previous code (that
mostly used \type{getc} calls), it can be quite a bit faster
(depending on your I/O subsystem).



\chapter{Known bugs}

\startitemize
\item Under some conditions, the {\bf autoexpand} font feature can crash the
executable.

\item {\bf Hyphenation} can only deal with the Base Multilingual Plane (BMP)

\item There are (sometimes?) UTF-8 encoded UTF-8 bytes in the
pseudo-buffer lines that are shown during error()

\stopitemize

\chapter{TODO}

On top of the `normal' extensions that are planned, there are some
more specific small feature requests .

\startitemize

\item Low-level support is still missing but needed to escape from the UTF-8
regime when dealing with \type{\special} and \type{\pdfliteral}.

\item Implement the \TEX\ primitive \type{\dimension}, cf. \type{\number}

\item Change the lua table type{tex.dimen} to accept and return float
values instead of strings

\item Do something about \type{\withoutpt} and/or a new register type \type{\real}?

\item Implement the \TEX\ primitive \type{\htdp}?

\item Do boxes with dual baselines.

\item A way to (re?)calculate the width of a  \type{\vbox}, taking only
the natural width of the included items into account.

\stopitemize


\stoptext


